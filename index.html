<!DOCTYPE html>
<html>

<head>

    <title>Page Title</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</head>

<style>
    .main-wrapper {
        height: 100vh;
    }

    .my-background {
        background-color: rgb(240, 235, 248);
        ;
    }

    .my-color {
        background-color: #673ab7;
    }

    .number-font {

        font-family: "Helvetica", "Arial", "LiHei Pro", "黑體-繁", "微軟正黑體", sans-serif;
        color: #673ab7;

    }
</style>


<body>
    <div id="root" class="my-background d-flex flex-column flex-grow-1 main-wrapper ">
        <div class="d-flex flex-column flex-grow-1 ">

            <div class="d-flex flex-row flex-grow-0  justify-content-center ">

                <div class="d-flex flex-row flex-grow-1 bg-white justify-content-center align-items-center">

                    <div class="flex-row number-font">
                        <h3 id="formsclock">10 min &nbsp;</h3>
                    </div>

                    <div class="flex-column bg-whith" style="width:50%">

                        <div class="progress ">
                            <div id="formsbar" class="progress-bar progress-bar-striped progress-bar-animated my-color" style="width:40%"></div>
                          </div>
                    </div>


                </div>
            </div>
            <div class="d-flex flex-row " >
                <h6 id="info" class="text-center" hidden></h6>
            </div>

            <iframe class="d-flex flex-grow-1" id="formsframe"
                src="https://docs.google.com/forms/d/e/1FAIpQLSean7gSYtmX6Wbq41U8sxrB1Qv5dvFtYhngBylqw0G-Z49o-A/viewform?embedded=true"
                frameborder="0">載入中…</iframe>


        </div>




    </div>

</body>

</html>
<script>
    queryString = window.location.search;
    console.log(queryString);
    urlParams = new URLSearchParams(queryString);
    ts = urlParams.get("ts");

    // WyIxRkFJcFFMU2NzMWtXYzVqNklnaVNfbWo4YVJfNVFPQ2s3Z2dYR01qQ2taM3c1NEJUbjRKY0xUdyIsMTYzMTE5MzMwMDAwMCw1LDNd
    var timestruct = JSON.parse(atob(ts));
    var formsframe = document.getElementById("formsframe");
    formsframe.src = "https://docs.google.com/forms/d/e/" + timestruct[0] + "/viewform?embedded=true";



    function checktime() {
        let timestruct = window.timestruct;
        let starttime = new Date(timestruct[1]);
        let endtime = new Date(timestruct[1]);
        let delta = timestruct[2];
        let levelnum = timestruct[3];
        endtime.setMinutes(endtime.getMinutes() + delta * levelnum);
        let now = new Date();


        let timeallsec = delta * levelnum * 60;
        let timeleftsec = Math.max(0, (endtime.getTime() - now.getTime()) / 1000);

        let formsclock = document.getElementById("formsclock");

        if(now.getTime() < starttime.getTime()) {
            timeallsec = 10 * 60;
            timeleftsec = -(now.getTime() - starttime.getTime()) /1000;

            let minleft = String(Math.floor(timeleftsec/60)).padStart(2, '0');
            let secleft = String(Math.floor(timeleftsec%60)).padStart(2, '0');

            formsclock.innerHTML = `開啟倒數 ${minleft}:${secleft} &nbsp;`;
        } else {
            timeleftsec = Math.max(0, (endtime.getTime() - now.getTime()) / 1000);
            let minleft = String(Math.floor(timeleftsec/60)).padStart(2, '0');
            let secleft = String(Math.floor(timeleftsec%60)).padStart(2, '0');

            formsclock.innerHTML = `關閉倒數 ${minleft}:${secleft} &nbsp;`;
        }





        // Math.max(0, Math.floor(timeleftsec/60)) + " min &nbsp;";
        let formsbar = document.getElementById("formsbar");
        formsbar.style = "width:" + ((timeleftsec / timeallsec) * 100) + "%";

        let info = document.getElementById("info");
        info.innerText = `開始時間: ${starttime} \n結束時間: ${endtime} \n每區段間格: ${delta} 間格數量: ${levelnum}`
        console.log(timeleftsec + "/" + timeallsec);
        console.log(((timeleftsec / timeallsec) * 100));
    }

    setInterval(function() {
        checktime();
    }, 1000);
    checktime();

</script>
