<!DOCTYPE html>
<html>

<head>

    <title>Page Title</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</head>

<style>
    .main-wrapper {
        height: 100vh;
    }

    .my-background {
        background-color: rgb(240, 235, 248);
        ;
    }

    .my-color {
        background-color: #673ab7;
    }

    .number-font {

        font-family: "Helvetica", "Arial", "LiHei Pro", "黑體-繁", "微軟正黑體", sans-serif;
        color: #673ab7;

    }
</style>


<body>
    <div id="root" class="my-background d-flex flex-column flex-grow-1 main-wrapper ">


        <!-- 
            <div class="d-flex flex-row flex-grow-0  justify-content-center ">

                <div class="d-flex flex-column flex-grow-1 bg-white justify-content-center align-items-center">

                    <div class="d-flex bd-highlight">
                        <div class="p-2 flex-fill bd-highlight">Flex item with a lot of content</div>
                        <div class="p-2 flex-fill bd-highlight">Flex item</div>
                        <div class="p-2 flex-fill bd-highlight">Flex item</div>
                      </div>


                    <div class="d-flex flex-row flex-grow-1">
                        <div class="p-2 flex-fill number-font">
                            <h3 id="formsclock">未設定 &nbsp;</h3>
                        </div>

                        <div class="p-2 flex-fill bg-whith" style="width:50%">

                            <div class="progress ">
                                <div id="formsbar"
                                    class="progress-bar progress-bar-striped progress-bar-animated my-color"
                                    style="width:40%"></div>
                            </div>
                        </div>
                    </div>



                </div>
            </div>-->


        <div class="bg-white  w-100  d-flex flex-column  align-items-stretch ">

                <div class="">
                    <div class="d-flex align-items-center flex-row"  style="max-width: 720px; margin-left: auto;margin-right: auto;">

                        <div class="p-2 number-font">
                            <h5 id="formsclock">未設定 &nbsp;</h5>
                        </div>
                        <div class="p-2 flex-grow-1">
                            <div class="progress" style="height:25px;">
                                <div id="formsbar"
                                    class="progress-bar progress-bar-striped progress-bar-animated my-color"
                                    style="width:40%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center flex-row"  style="max-width: 720px; margin-left: auto;margin-right: auto;">

                        <div class="p-2 number-font">
                            <h6 id="levelclock">未開始 &nbsp;</h6>
                        </div>
                        <div class="p-2 flex-grow-1">
                            <div class="progress" style="height:15px;">
                                <div id="levelbar"
                                    class="progress-bar progress-bar-striped progress-bar-animated my-color"
                                    style="width:0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>




        <div class="">
            <h6 id="info" class="text-center" hidden></h6>
        </div>

        <iframe class="flex-grow-1" id="formsframe"
            src="https://docs.google.com/forms/d/e/1FAIpQLScs1kWc5j6IgiS_mj8aR_5QOCk7ggXGMjCkZ3w54BTn4JcLTw/viewform?embedded=true"
            frameborder="0">載入中…</iframe>
    </div>

</body>

</html>
<script>
    let queryString = window.location.search;
    console.log(queryString);
    let urlParams = new URLSearchParams(queryString);
    let ts = urlParams.get("ts");

    // WyIxRkFJcFFMU2NzMWtXYzVqNklnaVNfbWo4YVJfNVFPQ2s3Z2dYR01qQ2taM3c1NEJUbjRKY0xUdyIsMTYzMTE5MzMwMDAwMCw1LDNd
    var timestruct = JSON.parse(atob(ts));
    var formsframe = document.getElementById("formsframe");
    formsframe.src = "https://docs.google.com/forms/d/e/" + timestruct[0] + "/viewform?embedded=true";
    if (timestruct[4]) {
        document.title = timestruct[4];
    }
    console.log(timestruct);

    let title = urlParams.get("title");
    if (title) {
        document.title = title;
    }

    function checktime() {
        let timestruct = window.timestruct;
        let starttime = new Date(timestruct[1]);
        let endtime = new Date(timestruct[1]);
        let delta = timestruct[2];
        let levelnum = timestruct[3];
        endtime.setMinutes(endtime.getMinutes() + delta * levelnum);
        let now = new Date();



        if(now.getTime() > endtime.getTime()) {
            levelclock.innerHTML = "第 " + levelnum + " 頁結束倒數 00:00 &nbsp;";
            levelbar.style = "width:0%";
        }
        else if (now.getTime() > starttime.getTime()) {
            let leveldelta = (endtime.getTime() - now.getTime())  / 1000;
            
            let levelclock = document.getElementById("levelclock");
            let levelbar = document.getElementById("levelbar");
            let level = levelnum - Math.floor(leveldelta / (delta * 60));

            let levelleft = leveldelta % (delta * 60);


            let minleft = String(Math.floor(levelleft / 60)).padStart(2, '0');
            let secleft = String(Math.floor(levelleft % 60)).padStart(2, '0');

            levelclock.innerHTML = `第 ${level+1} 頁結束倒數 ${minleft}:${secleft} &nbsp;`;
            levelbar.style = "width:" + ((levelleft * 100 / (delta * 60))) + "%";
        }


        let timeallsec = delta * levelnum * 60;
        let timeleftsec = Math.max(0, (endtime.getTime() - now.getTime()) / 1000);

        let formsclock = document.getElementById("formsclock");

        if (now.getTime() < starttime.getTime()) {
            timeallsec = 10 * 60;
            timeleftsec = -(now.getTime() - starttime.getTime()) / 1000;

            let minleft = String(Math.floor(timeleftsec / 60)).padStart(2, '0');
            let secleft = String(Math.floor(timeleftsec % 60)).padStart(2, '0');

            formsclock.innerHTML = `表單開始倒數 ${minleft}:${secleft} &nbsp;`;
        } else {
            timeleftsec = Math.max(0, (endtime.getTime() - now.getTime()) / 1000);
            let minleft = String(Math.floor(timeleftsec / 60)).padStart(2, '0');
            let secleft = String(Math.floor(timeleftsec % 60)).padStart(2, '0');

            formsclock.innerHTML = `表單結束倒數 ${minleft}:${secleft} &nbsp;`;
        }

        // Math.max(0, Math.floor(timeleftsec/60)) + " min &nbsp;";
        let formsbar = document.getElementById("formsbar");
        formsbar.style = "width:" + ((timeleftsec / timeallsec) * 100) + "%";

        let info = document.getElementById("info");
        info.innerText = `開始時間: ${starttime} \n結束時間: ${endtime} \n每區段間格: ${delta} 間格數量: ${levelnum}`
        // console.log(timeleftsec + "/" + timeallsec);
        // console.log(((timeleftsec / timeallsec) * 100));
    }

    setInterval(function () {
        checktime();
    }, 500);
    checktime();

</script>
